name: CI

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: read

jobs:
  markdown-lint:
    name: Markdown lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          # Lint all .md files; ignore node_modules and .github internals
          markdownlint '**/*.md' \
            --ignore 'node_modules/**' \
            --ignore '.github/**' \
            --config .markdownlint.json 2>/dev/null \
            || markdownlint '**/*.md' \
                 --ignore 'node_modules/**' \
                 --ignore '.github/**' \
                 --disable MD013 MD033 MD041 --

  link-check:
    name: Link check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.mlc-config.json'
          folder-path: '.'
          file-extension: '.md'
        # Treat broken links as warnings, not hard failures, for doc repos
        continue-on-error: true

  ci-summary:
    name: CI summary
    runs-on: ubuntu-latest
    needs:
      - markdown-lint
      - link-check
    if: always()
    steps:
      - name: Summarize results
        shell: bash
        run: |
          set -euo pipefail
          echo "markdown-lint : ${{ needs.markdown-lint.result }}"
          echo "link-check    : ${{ needs.link-check.result }}"

          for r in "${{ needs.markdown-lint.result }}" "${{ needs.link-check.result }}"; do
            if [[ "$r" == "failure" || "$r" == "cancelled" ]]; then
              echo "One or more CI jobs failed/cancelled."
              exit 1
            fi
          done

          echo "CI summary: OK"
